Of course. Here is a comprehensive, step-by-step guide on how to set up and use Supervisor on Ubuntu to run your new Laravel Artisan command as a background process.
Supervisor is the perfect tool for this job. It's a process control system that will:
Start your app:process-render-jobs command automatically when the server boots.
Monitor the command and automatically restart it if it ever crashes.
Provide simple commands to start, stop, and check the status of your process.
Capture the output and error logs from your command.
Step 1: Install Supervisor
First, update your package list and install Supervisor using apt.
code
Bash
sudo apt-get update
sudo apt-get install supervisor
Once installed, the Supervisor service will start automatically. You can verify its status with:
code
Bash
sudo systemctl status supervisor
You should see an active (running) status.
Step 2: Create a Configuration File for Your Worker
Supervisor's configuration files live in /etc/supervisor/conf.d/. You create a new .conf file for each process you want to manage. Let's create one for your image rendering command.
Create a new file named render-worker.conf:
code
Bash
sudo nano /etc/supervisor/conf.d/render-worker.conf
Now, paste the following configuration into the file. You must change the paths and user to match your server's setup.
code
Ini
[program:render-worker]
process_name=%(program_name)s_%(process_num)02d
command=/usr/bin/php /var/www/your-project-path/artisan app:process-render-jobs
autostart=true
autorestart=true
user=www-data
numprocs=1
redirect_stderr=true
stdout_logfile=/var/www/your-project-path/storage/logs/render-worker.log
stopwaitsecs=3600
Explanation of Each Line:
[program:render-worker]: This is the name of your program block. You'll use render-worker to manage this process.
process_name=%(program_name)s_%(process_num)02d: A unique name for each process instance. If numprocs is 1, this will be render-worker_00.
command=/usr/bin/php /var/www/your-project-path/artisan app:process-render-jobs: This is the most important line.
/usr/bin/php: Use the full path to your PHP executable. You can find it by running which php.
/var/www/your-project-path/artisan: The absolute path to your Laravel project's artisan file. Replace /var/www/your-project-path with the actual path.
app:process-render-jobs: The signature of the command you created.
autostart=true: Automatically start this process when Supervisor starts (e.g., on server boot).
autorestart=true: Automatically restart the process if it exits unexpectedly (e.g., if it crashes).
user=www-data: Very important for permissions. Run the command as this user. www-data is the standard user for Nginx/Apache on Ubuntu. This ensures your script can write to log files and storage directories without permission errors.
numprocs=1: How many instances of this process to run. For your specific script, 1 is correct.
redirect_stderr=true: Redirect any standard error output (like PHP errors) to the standard output file.
stdout_logfile=/var/www/your-project-path/storage/logs/render-worker.log: The path where all echo, info(), error() output from your command will be logged. Make sure this path is correct and the user (www-data) has permission to write to it.
stopwaitsecs=3600: When stopping the process, wait up to this many seconds for it to finish its current task gracefully before killing it.
Save the file and exit nano (press Ctrl+X, then Y, then Enter).
Step 3: Activate the New Configuration
After creating or changing a configuration file, you need to tell Supervisor to read it and apply the changes. This is a two-step process.
Reread: Tell Supervisor to check the conf.d directory for any new or changed files.
code
Bash
sudo supervisorctl reread
You should see output like: render-worker: available
Update: Tell Supervisor to enact any changes. This will start any new programs.
code
Bash
sudo supervisorctl update
You should see output like: render-worker: added process group
Your worker is now running!
Step 4: Managing Your Worker Process
You can manage your worker using the supervisorctl command.
Check the status of all processes:
code
Bash
sudo supervisorctl status
You should see your worker in the list with a RUNNING status.
code
Code
render-worker:render-worker_00   RUNNING   pid 12345, uptime 0:01:23
Stop the worker:
code
Bash
sudo supervisorctl stop render-worker:*
Start the worker:
code
Bash
sudo supervisorctl start render-worker:*
Restart the worker (useful after deploying new code):
code
Bash
sudo supervisorctl restart render-worker:*
Step 5: Checking the Logs
Since your command runs in the background, you can't see its output directly. The log file you configured is essential for debugging.
To view the log file in real-time, use the tail command with the -f (follow) flag:
code
Bash
tail -f /var/www/your-project-path/storage/logs/render-worker.log
You will now see the output from your command's $this->info() and $this->error() calls as they happen. This is the primary way you will monitor and debug your running process. Press Ctrl+C to stop tailing the log.
You have now successfully converted your Python script to a robust, auto-restarting Laravel background process managed by Supervisor.
